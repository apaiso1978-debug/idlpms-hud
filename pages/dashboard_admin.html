<!doctype html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | IDLPMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/theme.css" />
    <link rel="stylesheet" href="../assets/css/styles.css" />
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/components/dna_bar_chart.js"></script>
</head>

<body class="bg-transparent p-6 overflow-y-auto overflow-x-hidden font-['Sarabun'] antialiased vs-scrollbar"
    style="height: auto; min-height: 100vh;">
    <div id="dashboard-content" class="max-w-[1600px] space-y-6 animate-in fade-in zoom-in-95 duration-500">
        <!-- Dynamic Content injected by JS -->
    </div>

    <script>
        // Mock school data
        const schoolData = {
            name: 'โรงเรียนตัวอย่างวิทยา',
            totalStudents: 450,
            totalClasses: 18,
            aggregateDNA: { k: 68, p: 72, a: 75, e: 65, d: 58 },
            districtAverage: { k: 62, p: 65, a: 68, e: 60, d: 55 }

        };

        const classroomBreakdown = [
            { id: 'CLS_101', name: 'ป.1/1', teacher: 'ครูสมหญิง', students: 28, avgDNA: { k: 65, p: 70, a: 72, e: 62, d: 55 } },
            { id: 'CLS_102', name: 'ป.1/2', teacher: 'ครูสมชาย', students: 27, avgDNA: { k: 62, p: 68, a: 70, e: 58, d: 52 } },
            { id: 'CLS_201', name: 'ป.2/1', teacher: 'ครูวิชัย', students: 30, avgDNA: { k: 70, p: 75, a: 78, e: 68, d: 60 } },
            { id: 'CLS_301', name: 'ป.3/1', teacher: 'ครูพิมพ์ใจ', students: 26, avgDNA: { k: 72, p: 78, a: 80, e: 70, d: 62 } },
            { id: 'CLS_401', name: 'ป.4/1', teacher: 'ครูธนกร', students: 25, avgDNA: { k: 68, p: 72, a: 75, e: 65, d: 58 } },
            { id: 'CLS_501', name: 'ป.5/1', teacher: 'ครูรัตนา', students: 24, avgDNA: { k: 75, p: 80, a: 82, e: 72, d: 65 } },

        ];

        function init() {
            let user = { role: 'ADMIN', schoolId: 'SCH_001', fullName: 'ผู้อำนวยการตัวอย่าง' };
            try {
                if (parent && parent.window && typeof parent.window.getCurrentUser === 'function') {
                    user = parent.window.getCurrentUser();
                }
            } catch (e) { console.log('Standalone mode'); }

            renderDashboard(user);
        }

        function renderDashboard(user) {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = `
                <!-- Header Section -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="role-badge role-badge-admin">Admin</span>
                        <h1 class="text-xl font-light text-[var(--vs-text-title)] uppercase">${schoolData.name}</h1>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-[13px] text-[var(--vs-text-muted)] font-light">
                            <span class="text-[var(--vs-accent)]">${schoolData.totalStudents}</span> นักเรียน | 
                            <span class="text-[var(--vs-accent)]">${schoolData.totalClasses}</span> ห้องเรียน
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: School Aggregate -->
                    <div class="lg:col-span-2">
                        <div class="dna-zone p-6">
                            <div class="dna-zone-header">
                                <div class="flex items-center gap-2">
                                    <h2 class="dna-zone-title">School Intelligence DNA</h2>
                                    <i class="icon i-exclamation-circle w-3.5 h-3.5 opacity-40 hover:opacity-100 text-[var(--vs-accent)] cursor-help transition-opacity" 
                                       data-tooltip="Aggregate DNA statistics across all students. Dashed line = District Average."></i>
                                </div>
                                <span class="role-badge role-badge-admin">Aggregate</span>
                            </div>
                            
                            <div class="dna-zone-content flex-col gap-4 mt-4">
                                <div id="bar-chart-container" class="w-full min-h-[280px]">
                                    <!-- Injected by JS -->
                                </div>

                                <!-- Summary Stats -->
                                <div class="grid grid-cols-3 gap-4 mt-4">
                                    <div class="p-4 rounded-[var(--vs-radius)] bg-[var(--vs-bg-deep)] border border-[var(--vs-border)] text-center">
                                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-1">Average</div>
                                        <div id="stat-avg" class="text-2xl font-light text-[var(--vs-accent)]">-</div>
                                    </div>
                                    <div class="p-4 rounded-[var(--vs-radius)] bg-[var(--vs-bg-deep)] border border-[var(--vs-border)] text-center">
                                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-1">Highest</div>
                                        <div id="stat-max" class="text-2xl font-light text-emerald-400">-</div>
                                    </div>
                                    <div class="p-4 rounded-[var(--vs-radius)] bg-[var(--vs-bg-deep)] border border-[var(--vs-border)] text-center">
                                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-1">Lowest</div>
                                        <div id="stat-min" class="text-2xl font-light text-rose-400">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Classroom Breakdown -->
                    <div class="lg:col-span-1">
                        <div class="dna-zone p-4">
                            <div class="dna-zone-header">
                                <h2 class="dna-zone-title">Classrooms</h2>
                                <span class="text-[13px] text-[var(--vs-text-muted)]">${classroomBreakdown.length} ห้อง</span>
                            </div>
                            <div class="dna-zone-content flex-col items-stretch gap-2 mt-4 max-h-[450px] overflow-y-auto vs-scrollbar">
                                ${classroomBreakdown.map(cls => {
                const avgScore = Math.round(Object.values(cls.avgDNA).reduce((a, b) => a + b, 0) / 5);
                const statusColor = avgScore >= 70 ? 'text-emerald-400' : avgScore >= 60 ? 'text-amber-400' : 'text-rose-400';
                return `
                                    <div class="p-3 rounded-[var(--vs-radius)] bg-[var(--vs-bg-deep)] hover:bg-[var(--vs-bg-card)] cursor-pointer transition-colors group border border-transparent hover:border-[var(--vs-border)]"
                                         onclick="viewClassroom('${cls.id}')">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-[13px] text-[var(--vs-text-title)] font-light">${cls.name}</span>
                                            <span class="text-[13px] font-light ${statusColor}">${avgScore}%</span>
                                        </div>
                                        <div class="flex items-center justify-between text-[13px] text-[var(--vs-text-muted)]">
                                            <span class="Thai-Rule">${cls.teacher}</span>
                                            <span>${cls.students} คน</span>
                                        </div>
                                        <div class="mt-2 vs-progress-track">
                                            <div class="vs-progress-fill opacity-60" style="width: ${avgScore}%"></div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize Bar Chart
            renderBarChart();
        }

        function renderBarChart() {
            const container = document.getElementById('bar-chart-container');
            const chart = new DNABarChart(container, {
                barHeight: 28,
                showBenchmark: true,
                benchmarkValue: 60
            });
            chart.setData(schoolData.aggregateDNA, schoolData.districtAverage);

            // Update summary stats
            const summary = chart.getSummary();
            document.getElementById('stat-avg').textContent = `${summary.avg}%`;
            document.getElementById('stat-max').textContent = `${summary.max}%`;
            document.getElementById('stat-min').textContent = `${summary.min}%`;
        }

        function viewClassroom(classId) {
            // Navigate to teacher dashboard for specific classroom
            console.log('View classroom:', classId);
            // Could redirect: window.location.href = `dashboard_teacher.html?class=${classId}`;
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>