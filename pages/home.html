<!doctype html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | IDLPMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/theme.css" />
    <link rel="stylesheet" href="../assets/css/styles.css" />
    <link rel="stylesheet" href="../assets/css/curriculum.css" />

    <!-- Core Services & Engines -->
    <script src="../src/services/DataService.js"></script>
    <script src="../src/services/AuthService.js"></script>
    <script src="../src/lib/AIAuditor.js"></script>
    <script src="../src/engines/DNAHarvester.js"></script>
    <script src="../src/engines/QuizEngine.js"></script>
    <script src="../src/engines/SecurityEngine.js"></script>

    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/secrets.local.js"></script>
    <script src="../assets/js/management.js" defer></script>
</head>

<body
    class="bg-[var(--vs-bg-main)] text-[var(--vs-text-body)] font-['Sarabun'] antialiased overflow-hidden vs-scrollbar"
    style="height: 100vh;">
    <div class="vs-page-frame animate-in fade-in zoom-in-95 duration-500">
        <!-- Unified Header -->
        <main class="vs-page-content vs-scrollbar">
            <div class="w-full space-y-6">

                <!-- Global Statistics (Hidden for Students) -->
                <div id="global-stats-row" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="p-6 rounded-[var(--vs-radius)] bg-[var(--vs-bg-card)] border border-[rgba(63,63,70,0.5)]">
                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-2 font-light Thai-Rule">
                            จำนวนนักเรียนทั้งหมด
                        </div>
                        <div id="statStudents" class="text-3xl font-light text-[var(--vs-text-title)]">
                            0
                        </div>
                        <div class="mt-4 flex items-center space-x-2 text-[13px] text-[var(--vs-success)] font-light">
                            <i class="icon i-lightning h-4 w-4"></i>
                            <span>+2.4% จากเดือนที่แล้ว</span>
                        </div>
                    </div>
                    <div class="p-6 rounded-[var(--vs-radius)] bg-[var(--vs-bg-card)] border border-[rgba(63,63,70,0.5)]">
                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-2 font-light Thai-Rule">
                            สถานศึกษาในเครือข่าย
                        </div>
                        <div id="statSchools" class="text-3xl font-light text-[var(--vs-text-title)]">
                            0
                        </div>
                        <div class="mt-4 flex items-center space-x-2 text-[13px] text-[var(--vs-accent)] font-light">
                            <i class="icon i-globe h-4 w-4"></i>
                            <span>เชื่อมต่อข้อมูลเรียลไทม์</span>
                        </div>
                    </div>
                    <div class="p-6 rounded-[var(--vs-radius)] bg-[var(--vs-bg-card)] border border-[rgba(63,63,70,0.5)]">
                        <div class="text-[13px] text-[var(--vs-text-muted)] uppercase mb-2 font-light Thai-Rule">
                            ภาระงานระบบ
                        </div>
                        <div id="statLoad" class="text-3xl font-light text-[var(--vs-text-title)]">
                            0
                        </div>
                        <div class="mt-4 h-1 w-full bg-[var(--vs-border)] rounded-[var(--vs-radius)] overflow-hidden">
                            <div class="h-full bg-[var(--vs-accent)]" style="width: 42%"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Grid / Mastery Hub -->
                <div id="main-mastery-grid" class="hidden">
                    <!-- Populated by ManagementEngine -->
                </div>

                <!-- Admin Stats Section -->
                <div id="admin-stats" class="grid grid-cols-1 lg:grid-cols-3 gap-2">
                    <!-- Recent Activities -->
                    <div class="lg:col-span-2 space-y-4">
                        <h3 class="text-[13px] font-light text-[var(--vs-text-muted)] uppercase Thai-Rule">
                            การแจ้งเตือนสำคัญ
                        </h3>
                        <div class="space-y-3">
                            <div
                                class="p-6 rounded-[var(--vs-radius)] bg-[var(--vs-bg-card)] border border-[rgba(63,63,70,0.5)] flex items-center justify-between hover:bg-[var(--vs-bg-panel)] transition-colors cursor-pointer group">
                                <div class="flex items-center space-x-4">
                                    <div
                                        class="w-10 h-10 rounded-[var(--vs-radius)] hud-border-rose hud-bg-rose flex items-center justify-center">
                                        <i class="icon i-shield h-5 w-5 text-[var(--vs-danger)]"></i>
                                    </div>
                                    <div>
                                        <div
                                            class="text-[13px] font-light text-[var(--vs-text-title)] group-hover:text-white Thai-Rule">
                                            การแจ้งเตือนความปลอดภัยระบบ
                                        </div>
                                        <div class="text-[13px] text-[var(--vs-text-muted)] font-light">
                                            กำหนดการเวลา 02:00 น. (UTC)
                                        </div>
                                    </div>
                                </div>
                                <i class="icon i-chevron-right h-4 w-4 text-[var(--vs-text-muted)]"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Role Quick Stats -->
                    <div class="space-y-4">
                        <h3 class="text-[13px] font-light text-[var(--vs-text-muted)] uppercase Thai-Rule">
                            แผงข้อมูลส่วนตัว
                        </h3>
                        <div
                            class="p-6 rounded-[var(--vs-radius)] bg-[var(--vs-bg-card)] border border-[rgba(63,63,70,0.5)] space-y-4">
                            <div class="flex items-center space-x-4">
                                <div id="userAvatar"
                                    class="w-12 h-12 rounded-[var(--vs-radius)] border border-[rgba(63,63,70,0.5)] flex items-center justify-center text-lg font-light text-[var(--vs-accent)]"
                                    style="background-color: rgba(var(--vs-accent-rgb), 0.2)">
                                    A
                                </div>
                                <div>
                                    <div id="userName"
                                        class="text-[13px] text-[var(--vs-text-title)] font-light Thai-Rule">
                                        Admin
                                    </div>
                                    <div id="userOrg" class="text-[13px] text-[var(--vs-text-muted)] uppercase">
                                        สังกัด / หน่วยงาน
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center text-[13px]">
                                <span class="text-[var(--vs-text-muted)] uppercase">สถานะ</span>
                                <span class="text-[var(--vs-success)] font-light uppercase">ออนไลน์</span>
                            </div>
                            <div class="flex justify-between items-center text-[13px]">
                                <span class="text-[var(--vs-text-muted)] uppercase">ระดับการเข้าถึง</span>
                                <span id="userPerm" class="text-[var(--vs-text-body)]">ระดับบริหาร</span>
                            </div>
                        </div>

                        <button
                            class="w-full py-2 bg-[var(--vs-bg-card)] hover:bg-[var(--vs-bg-panel)] text-[var(--vs-text-body)] text-[13px] font-light rounded-[var(--vs-radius)] border border-[rgba(63,63,70,0.5)] transition-colors Thai-Rule">
                            ดูข้อมูลโปรไฟล์ฉบับเต็ม
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function syncDashboard() {
            let userFunc = null;
            if (typeof getCurrentUser === 'function') {
                userFunc = getCurrentUser;
            } else if (window.parent && typeof window.parent.getCurrentUser === 'function') {
                userFunc = window.parent.getCurrentUser;
            }

            if (!userFunc || typeof IDLPMS_DATA === 'undefined')
                return;

            const user = userFunc();
            const data = IDLPMS_DATA;

            if (user) {
                // UI Sync
                document.getElementById('welcomeTitle').innerText =
                    `ยินดีต้อนรับกลับมา, ${user.fullName.split(' ')[0]}`;
                document.getElementById('roleBadge').innerText = user.name;

                const avatarEl = document.getElementById('userAvatar');
                avatarEl.innerText = user.avatar;
                avatarEl.className = `w-12 h-12 rounded-[var(--vs-radius)] flex items-center justify-center text-lg font-light`;
                avatarEl.style.borderColor = `rgba(var(--vs-accent-rgb), 0.5)`;
                avatarEl.style.backgroundColor = `rgba(var(--vs-accent-rgb), 0.2)`;
                avatarEl.style.color = `var(--vs-accent)`;

                document.getElementById('userName').innerText = user.fullName;

                // Smart Org Resolution
                let orgName = user.org || 'UNDEFINED';
                if (!user.org && user.schoolId && data.structure.schools[user.schoolId]) {
                    orgName = data.structure.schools[user.schoolId].name;
                } else if (!user.org && user.districtId && data.structure.districts[user.districtId]) {
                    orgName = data.structure.districts[user.districtId].name;
                }
                document.getElementById('userOrg').innerText = orgName;
                document.getElementById('userPerm').innerText = user.level || user.name;

                // Dynamic Stats (Context Aware)
                const isSchool = user.level === 'School' || user.role === 'STUDENT';
                const isMaBlud = user.schoolId === 'SCH_MABLUD';

                document.getElementById('statStudents').innerText = isSchool
                    ? (isMaBlud ? '250' : '2,450')
                    : data.stats.global.totalStudents;
                document.getElementById('statSchools').innerText = isSchool
                    ? '1'
                    : data.stats.global.totalSchools;
                document.getElementById('statLoad').innerText = isSchool
                    ? (isMaBlud ? '17 ครู' : '85%')
                    : data.stats.global.activeUsers;

                // Update label for "System Load" if it's a specific school view
                if (isSchool && isMaBlud) {
                    const loadLabel = document.querySelector('#statLoad').previousElementSibling;
                    if (loadLabel) loadLabel.innerText = 'จำนวนครูทั้งหมด';
                }

                // Mastery Grid vs Admin Stats Rendering
                const masteryGrid = document.getElementById('main-mastery-grid');
                const adminStats = document.getElementById('admin-stats');
                const globalStats = document.getElementById('global-stats-row');

                if (user.role === 'STUDENT') {
                    masteryGrid.classList.remove('hidden');
                    adminStats.classList.add('hidden');
                    globalStats.classList.add('hidden');

                    setTimeout(() => {
                        if (window.ManagementEngine) {
                            window.ManagementEngine.renderMainDashboard('main-mastery-grid');
                        }
                    }, 100);
                } else {
                    masteryGrid.classList.add('hidden');
                    adminStats.classList.remove('hidden');
                    globalStats.classList.remove('hidden');
                }
            }
        }
        window.addEventListener('load', syncDashboard);
    </script>
</body>

</html>