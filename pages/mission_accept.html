<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting for Confirmation | IDLPMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/theme.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <script src="../assets/js/data.js"></script>
    <script src="../src/services/DataService.js"></script>
    <script src="../src/services/InsForgeDataService.js"></script>
    <script src="../src/services/SyncEngine.js"></script>

    <!-- Native HUD Styles -->
    <style>
        .detail-label {
            font-size: 13px;
            font-weight: 300;
            color: var(--vs-text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
    </style>
</head>

<body class="p-6 Thai-Rule bg-transparent animate-in fade-in zoom-in-95 duration-300">

    <!-- Header -->
    <div
        class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-[rgba(63,63,70,0.5)] pb-4">
        <div class="flex items-center gap-2">
            <div
                class="w-10 h-10 rounded-[var(--vs-radius)] bg-[rgba(16,185,129,0.1)] border border-[rgba(16,185,129,0.3)] flex items-center justify-center shrink-0">
                <i class="icon i-command-line w-5 h-5 text-[var(--vs-success)]"></i>
            </div>
            <div>
                <h1 class="text-[15px] font-light text-[var(--vs-text-title)] flex items-center gap-2">
                    รอการยืนยันรับภารกิจ
                    <span
                        class="text-[13px] px-2 py-0.5 rounded-[var(--vs-radius)] bg-[rgba(234,179,8,0.1)] border border-[rgba(234,179,8,0.3)] text-[var(--vs-warning)] uppercase font-light">PENDING</span>
                </h1>
                <div class="text-[13px] text-[var(--vs-text-muted)] mt-0.5">
                    Mission Directive Payload
                </div>
            </div>
        </div>

        <!-- Action Area -->
        <div id="action-buttons" class="flex items-center gap-2">
            <button onclick="rejectMission()" id="btn-cancel"
                class="px-4 py-2 rounded-[var(--vs-radius)] text-[13px] text-[var(--vs-text-muted)] hover:text-[var(--vs-text-title)] hover:bg-[rgba(255,255,255,0.05)] transition-colors font-light Thai-Rule border border-transparent">
                กลับไปยังหน้าหลัก
            </button>
            <div id="additional-buttons-container" class="flex items-center gap-2">
                <button onclick="acceptMission()" id="btn-accept"
                    class="px-5 py-2 rounded-[var(--vs-radius)] bg-[rgba(34,197,94,0.1)] text-[var(--vs-success)] border border-[rgba(34,197,94,0.3)] hover:bg-[rgba(34,197,94,0.15)] hover:border-[rgba(34,197,94,0.5)] transition-all flex items-center gap-1.5 text-[13px] font-light Thai-Rule">
                    <i class="icon i-check w-4 h-4"></i>
                    ยืนยันรับภารกิจ (Accept)
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

        <!-- Mission Info Card -->
        <div
            class="md:col-span-2 p-5 rounded-[var(--vs-radius)] bg-white/[0.02] border border-[rgba(63,63,70,0.5)] space-y-5">
            <div>
                <div class="detail-label">Target Module / ภารกิจหลัก</div>
                <div class="text-[15px] text-[var(--vs-accent)] font-light flex items-center gap-2">
                    <i class="icon i-folder w-4 h-4 opacity-70"></i>
                    <span id="task-title">กำลังโหลดข้อมูล...</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-[rgba(63,63,70,0.3)]">
                <div>
                    <div class="detail-label">Assigned By / ผู้สั่งการ</div>
                    <div class="text-[13px] text-[var(--vs-text-title)]" id="task-assigner">-</div>
                </div>
                <div>
                    <div class="detail-label">Dispatched On / ส่งมอบเมื่อ</div>
                    <div class="text-[13px] text-[var(--vs-text-body)]" id="task-time">-</div>
                </div>
            </div>
        </div>

        <!-- Meta Info Card -->
        <div
            class="p-5 rounded-[var(--vs-radius)] bg-white/[0.02] border border-[rgba(63,63,70,0.5)] flex flex-col justify-between">
            <div>
                <div class="detail-label">Class / ประเภท</div>
                <div class="text-[13px] text-[var(--vs-warning)] font-light bg-[rgba(234,179,8,0.1)] inline-block px-2.5 py-1 rounded-[var(--vs-radius)] border border-[rgba(234,179,8,0.3)] mt-1"
                    id="task-type">
                    SYSTEM DIRECTIVE
                </div>
            </div>
            <div
                class="mt-4 text-[13px] text-[var(--vs-text-muted)] font-light leading-relaxed bg-[rgba(234,179,8,0.05)] p-3 rounded-[var(--vs-radius)] border border-[rgba(234,179,8,0.15)] flex items-start gap-2">
                <i class="icon i-information-circle w-3.5 h-3.5 text-[var(--vs-warning)] mt-0.5 shrink-0"></i>
                <div class="opacity-80">
                    ถ้ายืนยันรับภารกิจ ระบบจะส่งสถานะ 'กำลังดำเนินการ' กลับไปยังผู้สั่งการ เพื่อเริ่มนับเวลา Countdown
                    ทันที
                </div>
            </div>
        </div>

    </div>

    <!-- Submit Form Area (Hidden initially) -->
    <div id="submit-form-area"
        class="hidden p-5 rounded-[var(--vs-radius)] bg-white/[0.02] border border-[rgba(63,63,70,0.5)]">
        <h3 class="text-[13px] text-[var(--vs-text-title)] font-light Thai-Rule uppercase mb-4 flex items-center gap-2">
            <i class="icon i-document-text w-4 h-4 text-[var(--vs-success)]"></i>
            ส่งมอบงานและรายงานผลคะแนน
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
            <div>
                <label class="text-[13px] text-[var(--vs-text-muted)] font-light mb-1.5 block">คะแนนที่ได้
                    (Score)</label>
                <input type="number" id="submit-score"
                    class="w-full bg-[var(--vs-bg-deep)] border-none rounded-[var(--vs-radius)] text-[13px] text-[var(--vs-text-body)] font-light px-3 py-2 outline-none focus:ring-1 focus:ring-[rgba(34,211,238,0.3)]"
                    placeholder="เช่น 85">
            </div>
            <div>
                <label class="text-[13px] text-[var(--vs-text-muted)] font-light mb-1.5 block">คะแนนเต็ม (Max
                    Score)</label>
                <input type="number" id="submit-max-score"
                    class="w-full bg-[var(--vs-bg-deep)] border-none rounded-[var(--vs-radius)] text-[13px] text-[var(--vs-text-body)] font-light px-3 py-2 outline-none focus:ring-1 focus:ring-[rgba(34,211,238,0.3)]"
                    placeholder="เช่น 100" value="100">
            </div>
            <div class="sm:col-span-2">
                <label class="text-[13px] text-[var(--vs-text-muted)] font-light mb-1.5 block">หมายเหตุ / ลิงก์ผลงาน
                    (Details)</label>
                <textarea id="submit-details" rows="2"
                    class="w-full bg-[var(--vs-bg-deep)] border-none rounded-[var(--vs-radius)] text-[13px] text-[var(--vs-text-body)] font-light px-3 py-2 outline-none resize-none focus:ring-1 focus:ring-[rgba(34,211,238,0.3)]"
                    placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="toggleSubmitForm()"
                class="px-5 py-2 rounded-[var(--vs-radius)] text-[13px] text-[var(--vs-text-muted)] hover:text-[var(--vs-text-title)] hover:bg-white/5 transition-colors font-light Thai-Rule">
                ยกเลิก
            </button>
            <button onclick="confirmSubmitWork()"
                class="px-5 py-2 rounded-[var(--vs-radius)] bg-[rgba(34,197,94,0.1)] text-[var(--vs-success)] border border-[rgba(34,197,94,0.3)] hover:bg-[rgba(34,197,94,0.15)] hover:border-[rgba(34,197,94,0.5)] transition-all flex items-center gap-1.5 text-[13px] font-light Thai-Rule">
                <i class="icon i-paper-airplane w-4 h-4"></i>
                ยืนยันส่งมอบงาน
            </button>
        </div>
    </div>

    <!-- Logic -->
    <script>
        let currentTask = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Extract Task ID from hash (e.g., #taskId=DEL_123456)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const taskId = hashParams.get('taskId');

            if (!taskId) {
                document.getElementById('task-title').innerText = "ERROR: ไม่พบรหัสภารกิจ";
                document.getElementById('btn-accept').disabled = true;
                return;
            }

            // 2. Fetch Delegation Data from localStorage
            try {
                const raw = localStorage.getItem('idlpms_delegations_v1');
                if (raw) {
                    const allTasks = JSON.parse(raw);
                    currentTask = allTasks.find(t => t.id === taskId);
                }
            } catch (e) { console.error('Failed to parse delegations', e); }

            if (!currentTask) {
                document.getElementById('task-title').innerText = "ERROR: ภารกิจถูกยกเลิกหรือไม่มีในระบบแล้ว";
                document.getElementById('btn-accept').disabled = true;
                return;
            }

            // 3. Populate UI
            document.getElementById('task-title').innerText = currentTask.moduleTitle || 'ภารกิจสั่งการ';
            document.getElementById('task-assigner').innerText = currentTask.assignedByName || 'ผู้อำนวยการ / ผู้บริหาร';

            // Format time
            if (currentTask.timestamp) {
                const d = new Date(currentTask.timestamp);
                document.getElementById('task-time').innerText = d.toLocaleString('th-TH');
            }

            if (currentTask.status !== 'PENDING') {
                document.getElementById('status-stamp').innerText = currentTask.status;
                if (currentTask.status === 'COMPLETED') {
                    document.getElementById('status-stamp').style.color = 'var(--vs-success)';
                    document.getElementById('additional-buttons-container').innerHTML = ''; // Clear buttons
                } else if (currentTask.status === 'IN_PROGRESS') {
                    document.getElementById('status-stamp').style.color = 'var(--vs-accent)';

                    const btnContainer = document.getElementById('additional-buttons-container');
                    btnContainer.innerHTML = `
                        <button onclick="toggleSubmitForm()"
                            class="w-full sm:w-auto px-6 py-2 rounded-[var(--vs-radius)] bg-[rgba(34,197,94,0.1)] text-[var(--vs-success)] border border-[rgba(34,197,94,0.3)] hover:bg-[rgba(34,197,94,0.15)] hover:border-[rgba(34,197,94,0.5)] transition-all flex items-center justify-center gap-1.5 text-[13px] font-light Thai-Rule shadow-[0_0_8px_rgba(34,197,94,0.1)]">
                            <i class="icon i-document-text w-4 h-4"></i>
                            ส่งมอบงาน (กรอกคะแนน)
                        </button>
                        <button onclick="acceptMission()" id="btn-accept"
                            class="w-full sm:w-auto px-6 py-2 rounded-[var(--vs-radius)] bg-[rgba(34,211,238,0.1)] text-[var(--vs-accent)] border border-[rgba(34,211,238,0.3)] hover:bg-[rgba(34,211,238,0.15)] hover:border-[rgba(34,211,238,0.5)] transition-all flex items-center justify-center gap-1.5 text-[13px] font-light Thai-Rule shadow-[0_0_8px_rgba(34,211,238,0.1)]">
                            <i class="icon i-switch-horizontal w-4 h-4"></i>
                            หน้าต่างทำงานเป้าหมาย
                        </button>
                    `;
                    document.getElementById('btn-cancel').innerText = 'กลับไปยังหน้าหลัก';
                }
            }
        });

        // ═══════════════════════════════════════════
        //  ACTIONS
        // ═══════════════════════════════════════════

        window.acceptMission = () => {
            if (!currentTask) return;

            // 1. Tell Delegation Panel to mark as IN_PROGRESS
            if (currentTask.status === 'PENDING') {
                if (window.parent && window.parent.DelegationPanel) {
                    window.parent.DelegationPanel.markTaskInProgress(currentTask.id);
                }
            }

            // 2. Route directly to the actual module using ManagementEngine
            if (window.parent && window.parent.ManagementEngine) {
                const isAdhoc = currentTask.moduleId && String(currentTask.moduleId).startsWith('ADHOC');

                // Show loading state temporarily
                const btn = document.getElementById('btn-accept');
                btn.innerHTML = '<i class="icon i-refresh w-4 h-4 animate-spin"></i> กำลังเชื่อมต่อระบบ...';

                setTimeout(() => {
                    if (isAdhoc) {
                        window.parent.ManagementEngine.handleMenuClick('ADHOC_INBOX', 'pages/teacher_inbox.html');
                    } else {
                        // Crucial: Handoff exact module action ID to open the target interface
                        const handoffPath = `__SYSTEM_TASK__${currentTask.moduleId}`;
                        // Extract precise route stored during Director Delegation context-awareness
                        let targetRoute = currentTask.moduleRoute;

                        if (!targetRoute) {
                            // Fallback if legacy assignment missing route
                            const item = window.parent.ManagementEngine.findMenuItem(currentTask.moduleId);
                            targetRoute = item ? (item.page || item.path) : 'pages/home.html';
                        }

                        window.parent.ManagementEngine.handleMenuClick(currentTask.moduleId, targetRoute);
                    }
                }, 600); // Small artificial delay for premium mechanical feel
            }
        };

        window.rejectMission = () => {
            // Just go back to home/dashboard
            if (window.parent && window.parent.ManagementEngine) {
                window.parent.ManagementEngine.handleMenuClick('OVERVIEW', 'pages/home.html');
            }
        };

        window.toggleSubmitForm = () => {
            const formArea = document.getElementById('submit-form-area');
            const actionButtons = document.getElementById('action-buttons');

            if (formArea.classList.contains('hidden')) {
                formArea.classList.remove('hidden');
                actionButtons.classList.add('hidden');
            } else {
                formArea.classList.add('hidden');
                actionButtons.classList.remove('hidden');
            }
        };

        window.confirmSubmitWork = () => {
            if (!currentTask) return;

            const scoreVal = document.getElementById('submit-score').value;
            const maxScoreVal = document.getElementById('submit-max-score').value;
            const detailsVal = document.getElementById('submit-details').value.trim();

            const score = scoreVal ? parseFloat(scoreVal) : null;
            const maxScore = maxScoreVal ? parseFloat(maxScoreVal) : null;

            if (window.parent && window.parent.DelegationPanel) {
                window.parent.DelegationPanel.submitWork(currentTask.id, score, maxScore, detailsVal);

                // Route user back home after submit
                setTimeout(() => {
                    rejectMission();
                }, 1000);
            }
        };
    </script>
</body>

</html>